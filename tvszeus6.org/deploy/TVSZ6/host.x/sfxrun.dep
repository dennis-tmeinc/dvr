#!/bin/sh

echo Start update MDVR614 firmware...
echo Kill processes...
if [ -f /var/dvr/dvrsvr.pid ] ; then
  kill `cat /var/dvr/dvrsvr.pid` 
fi

if [ -f /var/dvr/glog.pid ] ; then
  kill `cat /var/dvr/glog.pid`
fi

if [ -f /var/dvr/ioprocess.pid ] ; then
   kill `cat /var/dvr/ioprocess.pid`
fi

for i in 1 2 3 4 5 6 7 8 9 10 ; do
  if [ -f /var/dvr/ioprocess.pid ] ; then
    sleep 2
  else
    break;
  fi
done

for i in 1 2 3 4 5 6 7 8 9 10 ; do
  if [ -f /var/dvr/dvrsvr.pid ] ; then
    sleep 2
  else
    break;
  fi
done

for i in 1 2 3 4 5 6 7 8 9 10 ; do
  if [ -f /var/dvr/glog.pid ] ; then
    sleep 2
  else
    break;
  fi
done

# copy fw_printenv to ram in case downgrading
#cp /davinci/dvr/fw_printenv /var
#ln -s /var/fw_printenv /var/fw_setenv

# remove old files
#rm -f -r /dav/dvr/*

# start copying files
echo Copying file to /dav, please wait.
cp -rf  * /mnt/nand
cd /mnt/nand
tar zxf dvr.tar.gz
sync
tar xzf etc.tar.gz
sync

rm dvr.tar.gz
rm etc.tar.gz


cd /mnt/nand/dvr 
tar xzf drivers.tar.gz
sync
rm drivers.tar.gz

rm /mnt/nand/sfxrun
rm /mnt/nand/firmwareid
sync


cd /mnt/nand/dvr

echo Firmware update complete. 
echo New Version:
cat firmwareid
echo
echo Turn off system power and turn on power again.


if [ -f /var/dvr/mcuversion ] ; then
  cd /mnt/nand/dvr
 ./ioprocess -reboot 8
fi


